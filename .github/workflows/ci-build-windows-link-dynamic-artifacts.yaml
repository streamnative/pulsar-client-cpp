#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

name: CI - Build binary artifacts for Windows with dynamic linked dependencies
on:
  push:
    tags:
      - '*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  package-windows-dynamic:
    timeout-minutes: 120
    name: Build CPP Client (${{ matrix.build.config }}) on ${{ matrix.configure.name }}
    runs-on: ${{ matrix.configure.os }}
    env:
      INSTALL_DIR: 'C:\\pulsar-cpp'
    strategy:
      fail-fast: false
      matrix:
        configure:
          - name: 'Windows x64'
            os: windows-2019
            triplet: x64-windows
            suffix: 'windows-win64'
            generator: 'Visual Studio 16 2019'
            arch: '-A x64'
          - name: 'Windows x86'
            os: windows-2019
            triplet: x86-windows
            suffix: 'windows-win32'
            generator: 'Visual Studio 16 2019'
            arch: '-A Win32'
        build:
          - config: Debug
          - config: Release

    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: Install vcpkg packages
        run: |
          vcpkg install --triplet ${{ matrix.configure.triplet }} > dependencies.txt

      - name: Build and package
        shell: bash
        run: |
          BUILD_DIR=./build
          mkdir -p $BUILD_DIR
          cmake -B $BUILD_DIR \
            -G "${{ matrix.configure.generator }}" ${{ matrix.configure.arch }} \
            -DBUILD_TESTS=OFF \
            -DVCPKG_TRIPLET=${{ matrix.configure.triplet }} \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_DIR }} \
            -DCMAKE_BUILD_TYPE=${{ matrix.build.config }} \
            -S .
          cmake --build $BUILD_DIR --parallel --config ${{ matrix.build.config }} --target install
          cp dependencies.txt ${{ env.INSTALL_DIR }}

      - name: Zip artifact
        shell: bash
        run: |
          mv ./vcpkg_installed ${{ env.INSTALL_DIR }}/
          7z a -tzip pulsar-${{ matrix.build.config }}-${{ matrix.configure.triplet }}.zip ${{ env.INSTALL_DIR }}/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: pulsar-${{ matrix.build.config }}-${{ matrix.configure.triplet }}
          path: pulsar-${{ matrix.build.config }}-${{ matrix.configure.triplet }}.zip
